name: CD - Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ACR_NAME: canadacaregistry
  RESOURCE_GROUP: canadaca-rg         
  LOCATION: canadacentral
  WEB_APP_NAME: canadaca-web
  JOB_NAME: canadaca-scraper

permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout
  packages: write

jobs:
  # Job 1: Build and Push (Runs automatically)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # Force 3.11 on the runner

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Log in to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and Push Image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }} .
          docker push ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }}
          # Tag as latest for convenience
          docker tag ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:latest
          docker push ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:latest

  # Job 2: Deploy (Waits for Manual Approval)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: 
      name: production
      url: https://${{ env.WEB_APP_NAME }}.${{ env.ACR_NAME }}.canadacentral.azurecontainerapps.io
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Get ACR Credentials
      - name: Get ACR Credentials
        id: acr-creds
        run: |
          echo "username=$(az acr credential show --name ${{ env.ACR_NAME }} --query username --output tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value --output tsv)" >> $GITHUB_OUTPUT

      # Deploy Web App
      - name: Update Web App Image
        uses: azure/container-apps-deploy-action@v1
        with:
          acrName: ${{ env.ACR_NAME }}
          acrUsername: ${{ steps.acr-creds.outputs.username }}
          acrPassword: ${{ steps.acr-creds.outputs.password }}
          containerAppName: ${{ env.WEB_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          location: ${{ env.LOCATION }}
          targetPort: 8000
          ingress: external
          imageToDeploy: ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }}
          envVars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ca-central-1
            ENVIRONMENT=production
            ACR_NAME=${{ env.ACR_NAME }}


      # Deploy Scraper Job
      - name: Update Scraper Job Image
        run: |
          # Get the environment ID from the web app we just deployed
          ACA_ENV_ID=$(az containerapp show --name ${{ env.WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.environmentId --output tsv)
          
          # Check if job exists
          if ! az containerapp job show --name ${{ env.JOB_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} > /dev/null 2>&1; then
            echo "Job does not exist. Creating..."
            az containerapp job create \
              --name ${{ env.JOB_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --environment "$ACA_ENV_ID" \
              --image ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }} \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ steps.acr-creds.outputs.username }} \
              --registry-password ${{ steps.acr-creds.outputs.password }} \
              --trigger-type "Manual" \
              --parallelism 1 \
              --replica-completion-count 1 \
              --replica-timeout 1800 \
              --replica-retry-limit 3 \
              --env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }}" "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" "AWS_REGION=ca-central-1" "ENVIRONMENT=production" \
              --cpu "0.5" --memory "1.0Gi"
          else
            echo "Job exists. Updating..."
            az containerapp job update \
              --name ${{ env.JOB_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/canadaca-chat:${{ github.sha }}
          fi
